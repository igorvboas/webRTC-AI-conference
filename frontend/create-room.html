<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Criar Sala de Consulta</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Estilos espec√≠ficos da sala */
        .room-header {
            background: linear-gradient(135deg, #A6CE39 0%, #95B832 100%);
            color: #0A0A0A;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
        }
        .room-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .room-name {
            font-size: 20px;
            font-weight: 700;
            color: #FFFFFF;
        }
        .room-role {
            background: rgba(166,206,57,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            color: #A6CE39;
        }
        .participant-name {
            display: none;
            background: rgba(166,206,57,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
            color: #A6CE39;
        }
        .participant-name.show {
            display: block;
        }
        .btn-end-room {
            background: #EF4444;
            border: none;
            border-radius: 8px;
            padding: 8px 20px;
            color: #FFFFFF;
            font-weight: 600;
            font-size: 14px;
        }
        .participant-form {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .participant-form.hide {
            display: none;
        }
        .participant-form-content {
            background: #1A1A1A;
            padding: 40px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            color: #FFFFFF;
        }

    </style>
</head>
<body>
    <div class="create-room-container">
        <div class="create-room-header">
            <div class="icon">üé•</div>
            <h1>Criar Sala de Consulta</h1>
            <p>Configure sua sala e compartilhe o link com o participante</p>
        </div>

        <!-- Formul√°rio de Cria√ß√£o -->
        <form id="create-room-form">
            <div class="mb-3">
                <label for="host-name" class="form-label">Seu Nome</label>
                <input 
                    type="text" 
                    class="form-control" 
                    id="host-name" 
                    placeholder="Ex: Dr. Silva" 
                    required
                >
            </div>

            <div class="mb-3">
                <label for="room-name" class="form-label">Nome da Sala</label>
                <input 
                    type="text" 
                    class="form-control" 
                    id="room-name" 
                    placeholder="Ex: Consulta Paciente X" 
                    required
                >
            </div>

            <button type="submit" class="btn btn-primary btn-create">
                Criar Sala de Consulta
            </button>
        </form>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Criando sala...</span>
            </div>
            <p class="mt-2">Criando sala...</p>
        </div>

        <!-- Link Gerado -->
        <div class="link-container" id="link-container">
            <h5 class="text-center mb-3">‚úÖ Sala Criada com Sucesso!</h5>
            
            <!-- Link do Participante -->
            <p class="text-muted small text-center mb-2">
                <strong>Link para o Participante:</strong><br>
                (Compartilhe este link)
            </p>
            <div class="room-link" id="room-link"></div>
            <button class="btn btn-copy" id="copy-btn">
                üìã Copiar Link do Participante
            </button>
            
            <!-- Link do Host (com role=host) -->
            <p class="text-muted small text-center mb-2 mt-4">
                <strong>Seu link (Host):</strong>
            </p>
            <div class="room-link" id="host-room-link" style="background: #e7f3ff; border-color: #007bff;"></div>
            <button class="btn btn-enter" id="enter-room-btn">
                üö™ Entrar na Sala como Host
            </button>

            <p class="text-muted small text-center mt-3">
                ‚è±Ô∏è A sala expira em 5 minutos se ningu√©m entrar
            </p>
        </div>
    </div>

    <!-- Scripts -->
    <!-- <script src="https://localhost:8181/socket.io/socket.io.js"></script> ALTERAR PARA A URL DO GCP-->
    <script src="https://localhost:8181/socket.io/socket.io.js"></script>
    <script src="config.js"></script>
    <script>
        // Gerar nome aleat√≥rio para o host (pode ser personalizado)
        const defaultHostName = "Host - " + Math.floor(Math.random() * 100000);
        
        // Conectar ao Socket.IO
        console.log("CONFIG.BACKEND_URL: ", CONFIG.BACKEND_URL)
        const socket = io.connect(CONFIG.BACKEND_URL || 'https://localhost:8181/', {
        //const socket = io.connect('https://localhost:8181/', {
            auth: {
                userName: defaultHostName,
                password: "x"
            }
        });

        const form = document.getElementById('create-room-form');
        const loading = document.getElementById('loading');
        const linkContainer = document.getElementById('link-container');
        const roomLinkEl = document.getElementById('room-link');
        const hostRoomLinkEl = document.getElementById('host-room-link');
        const copyBtn = document.getElementById('copy-btn');
        const enterRoomBtn = document.getElementById('enter-room-btn');

        let participantRoomUrl = ''; // Link para participante (SEM role)
        let hostRoomUrl = ''; // Link para host (COM role=host)

        // Criar sala
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const hostName = document.getElementById('host-name').value.trim();
            const roomName = document.getElementById('room-name').value.trim();

            if (!hostName || !roomName) {
                alert('Por favor, preencha todos os campos');
                return;
            }

            // Salvar nome do host
            localStorage.setItem('hostName', hostName);

            // Mostrar loading
            form.style.display = 'none';
            loading.classList.add('show');

            // Emitir evento para criar sala
            socket.emit('createRoom', {
                hostName: hostName,
                roomName: roomName
            }, (response) => {
                // Esconder loading
                loading.classList.remove('show');

                if (response.success) {
                    // ‚úÖ CORRE√á√ÉO: Gerar 2 links diferentes
                    // Link do PARTICIPANTE (sem role)
                    participantRoomUrl = response.roomUrl;
                    
                    // Link do HOST (com role=host)
                    hostRoomUrl = response.roomUrl + '&role=host';
                    
                    // Exibir links
                    roomLinkEl.textContent = participantRoomUrl;
                    hostRoomLinkEl.textContent = hostRoomUrl;
                    linkContainer.classList.add('show');
                    
                    console.log('‚úÖ Sala criada:', response.roomId);
                    console.log('üì§ Link participante:', participantRoomUrl);
                    console.log('üë®‚Äç‚öïÔ∏è Link host:', hostRoomUrl);
                } else {
                    // Erro
                    alert('Erro ao criar sala: ' + response.error);
                    form.style.display = 'block';
                }
            });
        });

        // Copiar link DO PARTICIPANTE
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(participantRoomUrl).then(() => {
                copyBtn.textContent = '‚úÖ Link Copiado!';
                copyBtn.style.background = '#218838';
                
                setTimeout(() => {
                    copyBtn.textContent = 'üìã Copiar Link do Participante';
                    copyBtn.style.background = '#28a745';
                }, 2000);
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('Erro ao copiar link. Copie manualmente: ' + participantRoomUrl);
            });
        });

        // Entrar na sala COMO HOST (usando link com role=host)
        enterRoomBtn.addEventListener('click', () => {
            if (hostRoomUrl) {
                window.location.href = hostRoomUrl;
            }
        });

        // Atualizar nome do host se j√° preencheu antes
        const savedHostName = localStorage.getItem('hostName');
        if (savedHostName) {
            document.getElementById('host-name').value = savedHostName;
        }
    </script>
</body>
</html>