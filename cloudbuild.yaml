substitutions:
  _SERVICE_NAME: webrtc-backend
  _REGION: us-central1
  _FRONTEND_URL: https://web-rtc-ai-conference-da05ulotr-igor-dev-public.vercel.app/

options:
  logging: CLOUD_LOGGING_ONLY

steps:
  # Build container image
  - name: gcr.io/cloud-builders/docker
    args: ["build", "-t", "gcr.io/$PROJECT_ID/webrtc-backend:$SHORT_SHA", "-t", "gcr.io/$PROJECT_ID/webrtc-backend:latest", "backend"]

  # Push image
  - name: gcr.io/cloud-builders/docker
    args: ["push", "gcr.io/$PROJECT_ID/webrtc-backend:$SHORT_SHA"]
  - name: gcr.io/cloud-builders/docker
    args: ["push", "gcr.io/$PROJECT_ID/webrtc-backend:latest"]

  # Deploy to Cloud Run
  - name: gcr.io/cloud-builders/gcloud
    args:
      [
        "run","deploy","$_SERVICE_NAME",
        "--image","gcr.io/$PROJECT_ID/webrtc-backend:$SHORT_SHA",
        "--region","$_REGION",
        "--platform","managed",
        "--allow-unauthenticated",
        "--port","8080",
        "--memory","512Mi",
        "--cpu","1",
        "--set-env-vars","NODE_ENV=production,FRONTEND_URL=${_FRONTEND_URL}",
        "--set-secrets","OPENAI_API_KEY=OPENAI_API_KEY:latest"
      ]

images:
  - "gcr.io/$PROJECT_ID/webrtc-backend:$SHORT_SHA"
  - "gcr.io/$PROJECT_ID/webrtc-backend:latest"

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/OPENAI_API_KEY/versions/latest
      env: OPENAI_API_KEY


